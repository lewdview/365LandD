<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>th3scr1b3 | 365 Days: Bootleg Memories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <style>
        :root { --neon-green: #0f0; --neon-pink: #ff00ff; --tape-gray: #2a2a2a; --crt-scanline: rgba(18, 16, 16, 0.5); }
        body { background-color: #050505; color: #e0e0e0; font-family: 'Courier Prime', monospace; overflow-x: hidden; }
        .crt-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 50; }
        .flicker { animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.9; } 5% { opacity: 0.8; } 10% { opacity: 0.95; } 100% { opacity: 0.9; } }
        .glitch-title { font-family: 'Rubik Glitch', system-ui; text-shadow: 2px 0 var(--neon-pink), -2px 0 var(--neon-green); animation: noise-anim 2s infinite linear alternate-reverse; }
        .cassette-card { transition: all 0.3s ease; border: 1px solid #333; background: #111; }
        .cassette-card:hover { border-color: var(--neon-green); transform: translateY(-2px) skewX(-1deg); box-shadow: 4px 4px 0px var(--neon-pink); }
        .marquee-container { overflow: hidden; white-space: nowrap; }
        .marquee-content { display: inline-block; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .active-playing { border-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
    </style>
</head>
<body class="flicker">

    <div class="crt-overlay"></div>
    <audio id="global-player"></audio>

    <nav class="fixed top-0 w-full z-40 bg-black/90 border-b border-gray-800 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-sm tracking-widest text-green-500">[REC] ● <span id="time-display">00:00:00:00</span></div>
            <div class="flex gap-6 text-xs uppercase tracking-widest">
                <a href="#archive" class="hover:text-green-400 decoration-wavy underline-offset-4 hover:underline">Archive</a>
                <a href="#" class="hover:text-pink-500 decoration-wavy underline-offset-4 hover:underline">Manifesto</a>
            </div>
        </div>
    </nav>

    <header class="min-h-screen flex flex-col justify-center items-center relative px-4 pt-20">
        <div class="text-center z-10 max-w-4xl">
            <p class="text-gray-500 mb-4 tracking-[0.5em] text-sm md:text-base">PROJECT: 365 DAYS</p>
            <h1 class="glitch-title text-6xl md:text-9xl font-bold mb-2 uppercase leading-tight">
                Light &<br> <span class="text-transparent bg-clip-text bg-gradient-to-r from-gray-100 to-gray-600">Dark</span>
            </h1>
            <div class="mt-4 relative inline-block">
                <div class="absolute -inset-1 bg-pink-600 blur opacity-20"></div>
                <h2 class="relative text-2xl md:text-4xl text-white font-bold tracking-tighter border-2 border-white px-4 py-1 uppercase transform -rotate-1">
                    Bootleg Memories
                </h2>
            </div>
            
            <p class="mt-12 text-sm md:text-lg max-w-lg mx-auto text-gray-400 leading-relaxed border-l-2 border-green-500 pl-4 text-left">
                "We found these tapes in the wreckage. Some are corrupted. Some are clear. All of them are true." <br>
                <span class="handwritten text-xs mt-2 block">- th3scr1b3</span>
            </p>

            <div class="mt-12 flex flex-col md:flex-row gap-4 justify-center">
                <button id="play-latest-btn" class="bg-green-600 text-black px-8 py-3 font-bold uppercase tracking-widest hover:bg-green-500 hover:shadow-[0_0_15px_rgba(0,255,0,0.5)] transition-all">
                    Initialize System
                </button>
            </div>
        </div>
    </header>

    <section id="archive" class="max-w-7xl mx-auto px-4 py-20 border-t border-gray-800">
        <div class="flex justify-between items-end mb-12">
            <div>
                <h3 class="text-3xl font-bold uppercase mb-2">The Archive</h3>
                <p id="status-text" class="text-xs text-green-500">/// CONNECTING TO SUPABASE...</p>
            </div>
            <div class="text-right">
                <span id="count-display" class="text-4xl font-bold text-gray-800">000</span><span class="text-xl text-gray-600">/365</span>
            </div>
        </div>

        <div id="grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            </div>
    </section>

    <footer class="fixed bottom-0 w-full bg-black border-t border-gray-800 py-2 z-40">
        <div class="marquee-container">
            <div class="marquee-content text-xs uppercase tracking-[0.2em] text-gray-500">
                th3scr1b3.art /// 365 Days of Light and Dark /// Bootleg Memories /// All Rights Reserved © 2026 /// No Signal Detected /// Listening to the Void ///
            </div>
        </div>
    </footer>

    <script>
        // === CONFIG & HELPERS ===
        const SUPABASE_PROJECT_ID = 'pznmptudgicrmljjafex';
        const SUPABASE_URL = `https://${SUPABASE_PROJECT_ID}.supabase.co`;
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6bm1wdHVkZ2ljcm1samphZmV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDE4ODUsImV4cCI6MjA3OTg3Nzg4NX0.syu1bbr9OJ5LxCnTrybLVgsjac4UOkFVdAHuvhKMY2g';
        const BUCKET_NAME = 'releaseready';
        
        // Month logic from releaseStorage.ts
        const MONTHS = [
            { name: 'january', end: 31 }, { name: 'february', end: 59 }, { name: 'march', end: 90 },
            { name: 'april', end: 120 }, { name: 'may', end: 151 }, { name: 'june', end: 181 },
            { name: 'july', end: 212 }, { name: 'august', end: 243 }, { name: 'september', end: 273 },
            { name: 'october', end: 304 }, { name: 'november', end: 334 }, { name: 'december', end: 365 }
        ];

        function getMonthFromDay(day) {
            let runningTotal = 0;
            for(let m of MONTHS) {
                if (day <= m.end) return m.name;
            }
            return 'january';
        }

        function fileNameToTitle(fileName) {
            return fileName
                .replace(/\.(mp3|wav|flac|m4a)$/i, '')
                .replace(/^\d+[\s-_]+/, '')
                .replace(/_/g, ' ')
                .replace(/[-]/g, ' ')
                .trim();
        }

        // Logic from releaseStorage.ts to build URLs
        function getReleaseReadyUrl(day, title, type = 'audio') {
            const month = getMonthFromDay(day);
            const paddedDay = String(day).padStart(2, '0');
            const ext = type === 'audio' ? 'wav' : 'jpg'; // Default to wav for simplicity
            const folder = type === 'audio' ? 'audio' : 'covers';
            const fileName = `${paddedDay} - ${title}.${ext}`;
            return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${folder}/${month}/${encodeURIComponent(fileName)}`;
        }

        // === MAIN LOGIC ===
        let allReleases = [];
        const audioPlayer = document.getElementById('global-player');
        
        async function init() {
            const grid = document.getElementById('grid-container');
            const status = document.getElementById('status-text');
            
            try {
                // Fetch from Edge Function
                const res = await fetch(`${SUPABASE_URL}/functions/v1/make-server-473d7342/analyses/load`, {
                    headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                
                let data = [];
                if(res.ok) {
                    const json = await res.json();
                    data = json.analyses || [];
                } else {
                    // Fallback to static if edge function fails
                    status.innerText = '/// ERR: EDGE FUNCTION FAIL. LOADING BACKUP...';
                    const localRes = await fetch('/releases.json');
                    const localJson = await localRes.json();
                    data = localJson.releases || [];
                }

                // Sort by date/id
                data.sort((a, b) => new Date(a.analyzedAt || a.date) - new Date(b.analyzedAt || b.date));
                
                // Process data into standard format
                allReleases = data.map((item, idx) => {
                    const day = idx + 1;
                    const title = item.title || fileNameToTitle(item.fileName);
                    return {
                        id: item.id,
                        day: day,
                        title: title,
                        // Use constructed URL logic from releaseStorage.ts
                        audioUrl: getReleaseReadyUrl(day, title, 'audio'),
                        coverUrl: getReleaseReadyUrl(day, title, 'cover'),
                        mood: (item.valence < 0.5) ? 'Dark' : 'Light',
                        length: item.duration ? Math.floor(item.duration/60) + ':' + String(Math.floor(item.duration%60)).padStart(2,'0') : '0:00'
                    };
                });

                document.getElementById('count-display').innerText = String(allReleases.length).padStart(3, '0');
                status.innerText = '/// DATA FRAGMENTS RESTORED.';
                document.getElementById('play-latest-btn').innerText = `PLAY TAPE ${String(allReleases.length).padStart(3,'0')}`;
                document.getElementById('play-latest-btn').onclick = () => playTrack(allReleases[allReleases.length-1]);

                renderGrid();

            } catch (e) {
                console.error(e);
                status.innerText = '/// CRITICAL FAILURE. SYSTEM OFFLINE.';
            }
        }

        function renderGrid() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            
            allReleases.forEach(track => {
                const card = document.createElement('div');
                card.className = 'cassette-card p-4 relative group cursor-pointer';
                card.onclick = () => playTrack(track);
                card.id = `card-${track.id}`;
                
                // Color based on mood
                const gradient = track.mood === 'Light' ? 'from-purple-900' : 'from-red-900';
                
                card.innerHTML = `
                    <div class="aspect-square bg-gray-800 mb-4 overflow-hidden relative">
                        <div class="absolute inset-0 bg-gradient-to-br ${gradient} to-black opacity-80"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-4xl font-bold text-white/10 group-hover:text-white/30 transition-all">DAY ${String(track.day).padStart(3,'0')}</div>
                        <img src="${track.coverUrl}" onerror="this.style.display='none'" class="absolute inset-0 w-full h-full object-cover mix-blend-overlay opacity-50 group-hover:opacity-100 transition-opacity" />
                    </div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-sm uppercase truncate w-32">${track.title}</h4>
                            <p class="text-[10px] text-gray-500 mt-1">${track.mood} Phase • ${track.length}</p>
                        </div>
                        <div id="indicator-${track.id}" class="w-2 h-2 rounded-full bg-gray-800"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function playTrack(track) {
            // Reset UI
            document.querySelectorAll('.cassette-card').forEach(c => c.classList.remove('active-playing'));
            document.querySelectorAll('[id^="indicator-"]').forEach(i => {
                i.classList.remove('bg-green-500', 'animate-pulse');
                i.classList.add('bg-gray-800');
            });

            // Set Active
            const card = document.getElementById(`card-${track.id}`);
            const ind = document.getElementById(`indicator-${track.id}`);
            if(card) card.classList.add('active-playing');
            if(ind) {
                ind.classList.remove('bg-gray-800');
                ind.classList.add('bg-green-500', 'animate-pulse');
            }

            // Play
            audioPlayer.src = track.audioUrl;
            audioPlayer.play().catch(e => console.log("Playback error (likely 404 on URL):", e));
            
            document.getElementById('status-text').innerText = `/// PLAYING: ${track.title.toUpperCase()}...`;
        }

        // Time Code Update
        setInterval(() => {
            const now = new Date();
            document.getElementById('time-display').innerText = now.toLocaleTimeString('en-US', {hour12: false}) + ':' + Math.floor(now.getMilliseconds()/10);
        }, 50);

        init();
    </script>
</body>
</html>